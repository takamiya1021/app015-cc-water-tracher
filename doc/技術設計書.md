# 水分摂取トラッカーアプリ 技術設計書

## 1. システム概要

### 1.1 技術アーキテクチャ
```
[ユーザーブラウザ]
       ↓
[PWA (React/Next.js)]
       ↓
[LocalStorage API]
```

### 1.2 技術スタック

#### フロントエンド
- **フレームワーク**: Next.js 15.x (React 19.x)
- **言語**: TypeScript 5.x
- **スタイリング**: Tailwind CSS v3
- **グラフライブラリ**: Recharts 2.x
- **PWA対応**: next-pwa
- **状態管理**: React Hooks (useState, useEffect, useContext)

#### データ管理
- **保存先**: ブラウザのLocalStorage
- **データ形式**: JSON
- **永続化**: ブラウザローカル保存

#### 開発・ビルドツール
- **パッケージマネージャー**: npm
- **リンター**: ESLint + Prettier
- **型チェック**: TypeScript
- **ビルド**: Next.js内蔵ビルドシステム

## 2. データモデル設計

### 2.1 データ構造定義

#### 水分摂取記録 (WaterIntake)
```typescript
interface WaterIntake {
  id: string;                    // 一意識別子 (UUID)
  timestamp: number;             // 記録日時 (Unix timestamp)
  amount: number;               // 摂取量 (ml)
  drinkType: 'water' | 'other'; // 飲み物種類
  date: string;                 // 日付 (YYYY-MM-DD)
}
```

#### 目標設定 (DailyGoal)
```typescript
interface DailyGoal {
  goalAmount: number;           // 目標摂取量 (ml)
  isCustom: boolean;           // カスタム設定かどうか
  bodyWeight?: number;         // 体重 (kg) - 自動計算用
  activityLevel?: 'light' | 'moderate' | 'intense'; // 活動量
  updatedAt: number;           // 更新日時
}
```

#### ユーザー設定 (UserSettings)
```typescript
interface UserSettings {
  dailyGoal: DailyGoal;
  presetAmounts: number[];     // プリセット量 [200, 350, 500, 1000]
  theme: 'light' | 'dark';     // テーマ設定
  notifications: boolean;       // 通知設定（将来拡張用）
}
```

### 2.2 LocalStorage キー構造
```typescript
// キー名の定数定義
const STORAGE_KEYS = {
  INTAKES: 'water-tracker-intakes',
  SETTINGS: 'water-tracker-settings',
  VERSION: 'water-tracker-version'
} as const;
```

## 3. コンポーネント設計

### 3.1 コンポーネント階層構造
```
App
├── Layout
│   ├── Header
│   └── Navigation
├── Pages
│   ├── HomePage (メイン画面)
│   │   ├── IntakeRecorder
│   │   ├── ProgressDisplay
│   │   └── TodaysSummary
│   ├── HistoryPage (履歴画面)
│   │   ├── PeriodSelector
│   │   ├── StatisticsCards
│   │   └── IntakeChart
│   └── SettingsPage (設定画面)
│       ├── GoalSetting
│       ├── BodyWeightInput
│       └── ActivityLevelSelector
└── Common
    ├── Button
    ├── Modal
    ├── ProgressBar
    └── Loading
```

### 3.2 主要コンポーネント仕様

#### IntakeRecorder (摂取記録コンポーネント)
```typescript
interface IntakeRecorderProps {
  onRecord: (amount: number, drinkType: DrinkType) => void;
}

// 機能:
// - プリセット量ボタン (200ml, 350ml, 500ml, 1000ml)
// - 自由入力フィールド
// - 飲み物種類選択 (水/その他)
// - 記録実行ボタン
```

#### ProgressDisplay (進捗表示コンポーネント)
```typescript
interface ProgressDisplayProps {
  currentAmount: number;
  goalAmount: number;
  percentage: number;
}

// 機能:
// - 円形またはバー形式の進捗表示
// - 現在量/目標量の数値表示
// - 達成率のパーセント表示
// - 100%達成時のお祝いアニメーション
```

#### IntakeChart (グラフ表示コンポーネント)
```typescript
interface IntakeChartProps {
  data: ChartData[];
  period: 'day' | 'week' | 'month';
  chartType: 'bar' | 'line';
}

// 機能:
// - Recharts を使用した棒グラフ・折れ線グラフ
// - 期間別データの可視化
// - インタラクティブなツールチップ
// - レスポンシブ対応
```

## 4. 機能別詳細設計

### 4.1 データ管理システム

#### LocalStorage ラッパーサービス
```typescript
class WaterTrackerStorage {
  // 摂取記録の保存・取得
  static saveIntake(intake: WaterIntake): void
  static getIntakesByDate(date: string): WaterIntake[]
  static getIntakesByDateRange(startDate: string, endDate: string): WaterIntake[]

  // 設定の保存・取得
  static saveSettings(settings: UserSettings): void
  static getSettings(): UserSettings

  // データのマイグレーション
  static migrateData(): void
  static getVersion(): string
}
```

#### データ集計ユーティリティ
```typescript
class DataAggregator {
  // 日別集計
  static getDailyTotal(intakes: WaterIntake[]): number

  // 週別集計
  static getWeeklyStats(intakes: WaterIntake[]): WeeklyStats

  // 月別集計
  static getMonthlyStats(intakes: WaterIntake[]): MonthlyStats

  // 達成率計算
  static calculateAchievementRate(total: number, goal: number): number
}
```

### 4.2 目標自動計算システム

#### 目標計算ロジック
```typescript
interface AutoCalculationParams {
  bodyWeight: number;           // 体重 (kg)
  activityLevel: 'light' | 'moderate' | 'intense';
}

class GoalCalculator {
  static calculateRecommendedIntake(params: AutoCalculationParams): number {
    const baseAmount = params.bodyWeight * 30; // 基本計算: 体重×30ml

    const activityBonus = {
      light: 0,
      moderate: 200,
      intense: 500
    };

    return baseAmount + activityBonus[params.activityLevel];
  }
}
```

### 4.3 PWA対応設計

#### Manifest設定
```json
{
  "name": "水分摂取トラッカー",
  "short_name": "WaterTracker",
  "description": "日々の水分摂取量を記録・管理するアプリ",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

#### Service Worker機能
- オフライン対応
- キャッシュ戦略
- バックグラウンド同期（将来拡張用）

## 5. UI/UX 設計

### 5.1 レスポンシブデザイン仕様

#### ブレークポイント
```css
/* Tailwind CSS ブレークポイント */
sm: 640px   /* スマートフォン縦向き */
md: 768px   /* タブレット */
lg: 1024px  /* デスクトップ */
xl: 1280px  /* 大画面デスクトップ */
```

#### レイアウト調整
- **モバイルファースト**: 320px〜 でのレイアウト最適化
- **タッチターゲット**: 最小44px×44pxのタッチ可能エリア
- **フォントサイズ**: 最小16pxでのアクセシビリティ対応

### 5.2 カラーパレット・デザインシステム

#### プライマリカラー
```css
/* 水をテーマにしたブルー系 */
--primary-50: #eff6ff;   /* 極薄いブルー - 背景 */
--primary-100: #dbeafe;  /* 薄いブルー - アクセント */
--primary-500: #3b82f6;  /* メインブルー - ボタン・強調 */
--primary-600: #2563eb;  /* ダークブルー - ホバー状態 */
--primary-700: #1d4ed8;  /* より濃いブルー - アクティブ状態 */
```

#### 進捗表示カラー
```css
/* 進捗レベル別の色分け */
--progress-low: #ef4444;     /* 赤 - 0-33% */
--progress-medium: #f59e0b;  /* オレンジ - 34-66% */
--progress-high: #3b82f6;    /* ブルー - 67-99% */
--progress-complete: #10b981; /* グリーン - 100%+ */
```

## 6. パフォーマンス最適化

### 6.1 バンドルサイズ最適化
- Tree shaking の活用
- Code splitting による遅延読み込み
- Next.js の Image 最適化機能

### 6.2 レンダリング最適化
- React.memo による不要な再レンダリング防止
- useMemo, useCallback による重い計算の最適化
- 仮想スクロールによる大量データ表示の最適化

### 6.3 データアクセス最適化
- LocalStorage読み書きの最適化
- インデックス作成による検索高速化
- バッチ処理による複数データ操作の効率化

## 7. セキュリティ・プライバシー

### 7.1 データプライバシー
- 全データをユーザーのブラウザローカルに保存
- 外部サーバーへのデータ送信なし
- クロスサイトスクリプティング(XSS)対策

### 7.2 入力値検証
```typescript
// 入力値バリデーション
class InputValidator {
  static validateAmount(amount: number): boolean {
    return amount > 0 && amount <= 9999;
  }

  static sanitizeUserInput(input: string): string {
    return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
  }
}
```

## 8. テスト戦略

### 8.1 テスト種類
- **単体テスト**: Jest + React Testing Library
- **統合テスト**: コンポーネント間の連携テスト
- **E2Eテスト**: Playwright (将来実装)

### 8.2 テスト対象
```typescript
// 重要なテストケース
describe('Water Intake Recording', () => {
  test('プリセット量での記録が正常に動作する')
  test('自由入力での記録が正常に動作する')
  test('無効な入力値が適切に処理される')
  test('LocalStorageへの保存が正常に動作する')
})

describe('Goal Calculation', () => {
  test('体重ベースの目標計算が正確である')
  test('活動量補正が正しく適用される')
})

describe('Data Aggregation', () => {
  test('日別集計が正確に計算される')
  test('週別・月別統計が正しく生成される')
})
```

## 9. デプロイメント・運用

### 9.1 ビルド・デプロイ設定
- **ビルドコマンド**: `npm run build`
- **静的エクスポート**: Next.js の static export 機能
- **デプロイ先**: Vercel または Netlify
- **カスタムドメイン**: 必要に応じて設定

### 9.2 監視・メンテナンス
- **エラー監視**: ブラウザコンソールログの分析
- **パフォーマンス監視**: Web Vitals の測定
- **ユーザビリティ改善**: 実際の使用データ分析

---

**作成日**: 2025年9月14日
**バージョン**: 1.0.0
**設計承認**: 要件定義書準拠